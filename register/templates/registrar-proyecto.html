{% extends "base.html" %}

{% block title %} Registrar Proyecto - PRISM DSS {% endblock %}

    {% block extra_css %}
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/registrar.css">
    <link rel="stylesheet" href="/static/css/dialog.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>

        .field-error-input { /* Cambié de .is-invalid a .field-error-input para no chocar con posibles librerías CSS */
            border-color: var(--danger-color) !important; /* Usar variable de color */
        }


        .error-message {
            color: var(--danger-color); /* Usar variable de color */
            font-size: 0.875em;
            margin-top: 0.25rem;
            display: block; /* Asegurarse de que ocupe su propia línea */
        }


        .alert-danger {
            color: #721c24; /* Rojo oscuro para el texto */
            background-color: #f8d7da; /* Fondo rojo claro */
            border-color: #f5c6cb; /* Borde rojo */
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
            /* Estilos para que se muestren y oculten via JS */
            display: none; /* Oculto por defecto, JS lo mostrará */
            /* Estilo para el resaltado temporal usado en JS (opcional) */
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.5); /* Usar color similar a danger */
            transition: box-shadow 0.3s ease-in-out; /* Transición suave para el resaltado */
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
            display: none; /* Oculto por defecto */
        }
    </style>
    {% endblock %}
</head>

{% block content %}
    <main class="main-content" id="mainContent">
        <div class="content-header">
            <h2>{% block module %} Registrar Nuevo Proyecto {% endblock %}</h2>
            <div class="breadcrumb">
                <span>Inicio</span> / <span class="active">{% block current_page %} Registrar Proyecto {% endblock %}</span>
            </div>
        </div>

        <div class="form-container">
            <form id="projectForm" action="{% url 'register'%}" method="POST">
                {% csrf_token %}

                <div id="general-messages" class="alert" style="display: none;"></div>

                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Información Básica</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="projectName">{{project_form.project_name.label}}</label>
                            {{project_form.project_name}}
                            <span class="error-message" id="error-project_name"></span> {# Contenedor de error #}
                        </div>

                        <div class="form-group">
                            <label for="projectType">{{project_form.project_type.label}}</label>
                            {{project_form.project_type}}
                            <span class="error-message" id="error-project_type"></span> {# Contenedor de error #}
                        </div>

                        <div class="form-group">
                            <label for="projectStatus">{{project_form.project_status.label}}</label>
                            {{project_form.project_status}}
                            <span class="error-message" id="error-project_status"></span> {# Contenedor de error #}
                        </div>

                        <div class="form-group">
                            <label for="projectBudget">{{project_form.project_budget.label}}</label>
                            <div class="input-group">
                                {{project_form.project_budget}}
                                {{project_form.project_budget_unit}}
                            </div>
                            <span class="error-message" id="error-project_budget"></span> {# Contenedor de error #}
                            <span class="error-message" id="error-project_budget_unit"></span> {# Contenedor de error #}
                        </div>

                        <div class="form-group">
                            <label for="projectDuration">{{project_form.project_duration.label}}</label>
                            <div class="input-group">
                                {{project_form.project_duration}}
                                {{project_form.project_duration_unit}}
                            </div>
                            <span class="error-message" id="error-project_duration"></span> {# Contenedor de error #}
                            <span class="error-message" id="error-project_duration_unit"></span> {# Contenedor de error #}
                        </div>

                        <div class="form-group">
                            <label for="projectLocation">{{project_form.project_location.label}}</label>
                            {{project_form.project_location}}
                            <span class="error-message" id="error-project_location"></span> {# Contenedor de error #}
                        </div>

                        <div class="form-group">
                            <label for="staffCount">{{project_form.staffCount.label}}</label>
                            {{project_form.staffCount}}
                            <span class="error-message" id="error-staffCount"></span> {# Contenedor de error #}
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="projectDescription">{{project_form.project_description.label}}</label>
                            <div class="help-content">
                                <div class="label-content">
                                    <label for="projectDescription">{{form.project_description.label}}</label>
                                </div>
                                <button class="btn" id="btn-help" type="button">
                                    <i class="fa-solid fa-circle-info"></i> Ayuda
                                </button>
                            </div> 
                            <br>
                        {{project_form.project_description}}
                        <span class="error-message" id="error-project_description"></span> {# Contenedor de error #}
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> Identificación de Riesgos</h3>
                    <div class="risk-container" id="risksContainer">
                        {{ project_risk.management_form }}

                        {% for form in project_risk %}
                            <div class="risk-item" data-risk-id="{{ forloop.counter0 }}"> {# Usar forloop.counter0 para indexar desde 0 #}
                                <div class="risk-header">
                                    <h4>Riesgo #{{ forloop.counter }}</h4>
                                    <button type="button" class="btn btn-remove-risk">
                                        <i class="fas fa-times"></i> Eliminar
                                    </button>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="{{ form.riskDescription.id_for_label }}">{{ form.riskDescription.label }}</label>
                                        {{ form.riskDescription }}
                                        <span class="error-message" id="error-{{ form.riskDescription.id_for_label }}"></span>
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.riskMitigation.id_for_label }}">{{ form.riskMitigation.label }}</label>
                                        {{ form.riskMitigation }}
                                        <span class="error-message" id="error-{{ form.riskMitigation.id_for_label }}"></span>
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.riskProbability.id_for_label }}">{{ form.riskProbability.label }}</label>
                                        {{ form.riskProbability }}
                                        <span class="error-message" id="error-{{ form.riskProbability.id_for_label }}"></span>
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.riskImpact.id_for_label }}">{{ form.riskImpact.label }}</label>
                                        {{ form.riskImpact }}
                                        <span class="error-message" id="error-{{ form.riskImpact.id_for_label }}"></span>
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.riskStatus.id_for_label }}">{{ form.riskStatus.label }}</label>
                                        {{ form.riskStatus }}
                                        <span class="error-message" id="error-{{ form.riskStatus.id_for_label }}"></span>
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.riskCategory.id_for_label }}">{{ form.riskCategory.label }}</label>
                                        {{ form.riskCategory }}
                                        <span class="error-message" id="error-{{ form.riskCategory.id_for_label }}"></span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" id="addRiskButton" class="btn btn-add-risk">
                        <i class="fas fa-plus"></i> Agregar Riesgo
                    </button>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancelBtn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-submit">
                        <i class="fas fa-save"></i> Guardar Proyecto
                    </button>
                </div>
            </form>
        </div>
    </main>

    <dialog id="dialog">
        <div id="dialog-content">
            <h3>Ayuda para realizar una correcta descripción</h3>
            <br>
            <p>Proporciona detalles como:</p>
            <br>
            <ul>
                <li><strong>Materiales:</strong> Ej. "Estructura de acero, acabados en madera y cerámica."</li>
                <li><strong>Características clave:</strong> Ej. "Casa de 2 pisos con terraza, cocina integrada y paneles solares."</li>
                <li><strong>Requerimientos técnicos:</strong> Ej. "Cimentación profunda por suelo arcilloso, sistema de recolección de agua pluvial."</li>
                <li><strong>Contexto:</strong> Ej. "Ubicado en zona sísmica, con normativas de altura específicas."</li>
            </ul>
            <button id="ok-button" type="button" class="btn">Aceptar</button>
        </div>
    </dialog>
{% endblock %}

{% block extra_js %}
    {% load static %}
    <script src="{% static 'js/registrar.js' %}"></script>
    <script src="{% static 'js/registrar.js' %}"></script>
{% endblock %}